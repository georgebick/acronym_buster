
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Acronym Buster</title>
<link rel="stylesheet" href="/static/style.css"/>
</head>
<body>
<header class="appbar">
  <h1>Acronym Buster</h1>
  <div class="ver">v4.6.5</div>
</header>

<main class="container">
  <form id="upload-form">
    <div class="drop">
      <input id="file" type="file" name="file" accept=".docx" />
      <p>Drop your Word (.docx) here or click to browse</p>
    </div>
    <div class="opts">
      <label><input id="use-web" name="use_web" type="checkbox" checked/> Use web sources</label>
      <label>Domain
        <select id="domain" name="domain">
          <option value="">General</option>
          <option value="tech">Tech / Web</option>
          <option value="bio">Biomedical</option>
          <option value="gov">Gov / Reg</option>
        </select>
      </label>
      <label><input id="strict" name="strict" type="checkbox" checked/> Strict initials</label>
      <button id="go" type="submit">Extract</button>
    </div>
  </form>

  <div id="progress" class="progress hidden">
    <div class="spinner"></div>
    <div>Extracting acronyms…</div>
  </div>

  <section id="summary" class="summary hidden"></section>
  <section id="results" class="results hidden"></section>
</main>

<script>
const form = document.getElementById('upload-form');
const file = document.getElementById('file');
const progress = document.getElementById('progress');
const results = document.getElementById('results');
const summary = document.getElementById('summary');

function showProgress(){ progress.classList.remove('hidden'); }
function hideProgress(){ progress.classList.add('hidden'); }

form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if (!file.files[0]) { alert('Choose a .docx file'); return; }
  const fd = new FormData();
  fd.append('file', file.files[0]);
  fd.append('use_web', document.getElementById('use-web').checked ? '1':'0');
  fd.append('domain', document.getElementById('domain').value);
  fd.append('strict', document.getElementById('strict').checked ? '1':'0');
  showProgress();
  const res = await fetch('/extract', { method:'POST', body: fd });
  const data = await res.json();
  hideProgress();
  render(data);
});

function bar(p){
  const v = Math.max(0, Math.min(100, Math.round((p||0)*100)));
  return `<div class="bar"><div class="fill" style="width:${v}%"></div><span>${v}%</span></div>`;
}

function render(data){
  const rows = data?.acronyms || [];
  const fromDoc = rows.filter(r => (r.candidates||[]).some(c => (c.source||'').includes('document'))).length;
  const fromWeb = rows.filter(r => (r.candidates||[]).some(c => (c.source||'').match(/wikipedia|wiktionary|mdn|w3c|acromine|pack/i))).length;
  summary.innerHTML = `<div class="sumgrid">
    <div><div class="t">Found</div><div class="v">${rows.length}</div></div>
    <div><div class="t">From document</div><div class="v">${fromDoc}</div></div>
    <div><div class="t">From web/APIs</div><div class="v">${fromWeb}</div></div>
  </div>`;
  summary.classList.remove('hidden');

  let html = `<table class="tbl"><thead><tr>
    <th>Acronym</th><th>Top pick</th><th>Conf.</th><th>Source</th><th class="hide-sm">First seen</th><th>Actions</th>
  </tr></thead><tbody>`;
  rows.forEach((r,i)=>{
    const c = (r.candidates||[])[0] || {};
    html += `<tr data-i="${i}">
      <td class="term">${r.term}</td>
      <td class="pick"><div class="ellip">${c.definition||'—'}</div></td>
      <td class="conf">${bar(c.confidence||0)}</td>
      <td class="src">${c.source||''}</td>
      <td class="first hide-sm"><div class="ellip">${(r.first_seen||'').slice(0,220)}</div></td>
      <td class="act"><button class="btn b-cands">Candidates</button><button class="btn b-save">Save</button></td>
    </tr>
    <tr class="cands hidden"><td colspan="6">
      ${(r.candidates||[]).map((k,ci)=>`
        <div class="cand">
          <span class="pill">${k.source||'web'}</span>
          <span class="c">${Math.round((k.confidence||0)*100)}%</span>
          <span class="d">${k.definition||''}</span>
          <span class="aa">
            <button class="btn tiny b-top" data-ci="${ci}">Make top</button>
            <button class="btn tiny b-learn" data-ci="${ci}">Learn</button>
          </span>
        </div>`).join('')}
    </td></tr>`;
  });
  html += `</tbody></table>`;
  results.innerHTML = html;
  results.classList.remove('hidden');
}

results.addEventListener('click', async (e)=>{
  const tr = e.target.closest('tr[data-i]');
  if (!tr) return;
  const i = parseInt(tr.dataset.i,10);
  if (e.target.classList.contains('b-cands')){
    const nxt = tr.nextElementSibling;
    if (nxt && nxt.classList.contains('cands')) nxt.classList.toggle('hidden');
  } else if (e.target.classList.contains('b-save')){
    const row = window.__last?.[i] || (window.__last = JSON.parse(JSON.stringify(window.__last || [])));
  }
});
</script>
</body>
</html>
