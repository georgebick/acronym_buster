<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Acronym Extractor</title>
  <link rel="stylesheet" href="/static/style.css" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <header class="hero">
    <div class="wrap">
      <h1>ðŸ“„ Acronym & Definition Extractor</h1>
      <p>Upload a Word <strong>.docx</strong> and we'll pull out acronyms with definitions from the document first â€” then the web as a fallback.</p>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <h2>Upload your document</h2>
      <div id="dropzone" class="dropzone">
        <input type="file" id="file" accept=".docx" />
        <div class="dz-instructions">
          <p><strong>Drag & drop</strong> a .docx here, or click to choose a file.</p>
          <small>We don't store your content. Parsing happens in-memory.</small>
        </div>
      </div>
      <div class="actions">
        <button id="extract-btn" disabled>Extract Acronyms</button>
        <button id="download-csv" disabled class="secondary">Download CSV</button>
      </div>
      <div id="status" class="status"></div>
      <div id="spinner" class="spinner hidden"></div>
    </section>

    <section id="results" class="card hidden">
      <div class="table-head">
        <h2>Results</h2>
        <input type="search" id="filter" placeholder="Filter acronyms or definitionsâ€¦" />
      </div>
      <div class="table-wrap">
        <table id="results-table">
          <thead>
            <tr>
              <th>Acronym</th>
              <th>Definition</th>
              <th>Confidence</th>
              <th>Source</th>
              <th>Note</th>
              <th>First seen</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer class="footer wrap">
    <small>Â© Acronym Extractor â€¢ Document-first definitions, web as fallback.</small>
  </footer>

  <script>
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('file');
    const extractBtn = document.getElementById('extract-btn');
    const downloadBtn = document.getElementById('download-csv');
    const status = document.getElementById('status');
    const spinner = document.getElementById('spinner');
    const resultsCard = document.getElementById('results');
    const tableBody = document.querySelector('#results-table tbody');
    const filterInput = document.getElementById('filter');

    let currentFile = null;
    let lastData = null;

    function setLoading(isLoading, text) {
      spinner.classList.toggle('hidden', !isLoading);
      if (text !== undefined) status.textContent = text || '';
    }

    function enableButtons(hasFile, hasData) {
      extractBtn.disabled = !hasFile;
      downloadBtn.disabled = !hasData;
    }

    dropzone.addEventListener('click', () => fileInput.click());
    dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('drag'); });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('drag'));
    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.classList.remove('drag');
      if (e.dataTransfer.files.length) {
        currentFile = e.dataTransfer.files[0];
        fileInput.files = e.dataTransfer.files;
        dropzone.querySelector('.dz-instructions p').innerHTML = `<strong>Selected:</strong> ${currentFile.name}`;
        enableButtons(true, !!lastData);
      }
    });
    fileInput.addEventListener('change', (e) => {
      currentFile = e.target.files[0];
      if (currentFile) {
        dropzone.querySelector('.dz-instructions p').innerHTML = `<strong>Selected:</strong> ${currentFile.name}`;
        enableButtons(true, !!lastData);
      }
    });

    function renderTable(data) {
      const rows = data.acronyms.map(a => `
        <tr>
          <td><code>${a.term}</code></td>
          <td>${a.definition ? a.definition : '<em>â€”</em>'}</td>
          <td>${(a.confidence||0).toFixed(2)}</td>
          <td><span class="pill ${a.source.startsWith('web:') ? 'pill-web' : (a.source==='document' ? 'pill-doc':'pill-none')}">${a.source}</span></td>
          <td>${a.note ? a.note : ''}</td>
          <td>${a.first_seen_excerpt ? a.first_seen_excerpt : ''}</td>
        </tr>
      `).join('');
      tableBody.innerHTML = rows;
      resultsCard.classList.remove('hidden');
    }

    function filterRows() {
      const q = filterInput.value.toLowerCase();
      Array.from(tableBody.querySelectorAll('tr')).forEach(tr => {
        const text = tr.textContent.toLowerCase();
        tr.style.display = text.includes(q) ? '' : 'none';
      });
    }
    filterInput.addEventListener('input', filterRows);

    async function extract() {
      if (!currentFile) return;
      const formData = new FormData();
      formData.append('file', currentFile);
      setLoading(true, 'Extractingâ€¦');
      enableButtons(false, false);

      try {
        const res = await fetch('/extract', { method: 'POST', body: formData });
        const data = await res.json();
        lastData = data;
        renderTable(data);
        status.textContent = `Found ${data.acronyms.length} acronym${data.acronyms.length===1?'':'s'}.`;
        enableButtons(!!currentFile, true);
      } catch (err) {
        status.textContent = 'Error: ' + (err.message || err);
      } finally {
        setLoading(false);
      }
    }

    async function downloadCSV() {
      if (!currentFile) return;
      const formData = new FormData();
      formData.append('file', currentFile);
      setLoading(true, 'Preparing CSVâ€¦');
      try {
        const res = await fetch('/extract-csv', { method: 'POST', body: formData });
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'acronyms.csv';
        a.click();
        URL.revokeObjectURL(url);
      } finally {
        setLoading(false);
      }
    }

    extractBtn.addEventListener('click', extract);
    downloadBtn.addEventListener('click', downloadCSV);
  </script>
</body>
</html>
